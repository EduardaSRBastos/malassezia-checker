<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:file="http://www.mulesoft.org/schema/mule/file" xmlns="http://www.mulesoft.org/schema/mule/core"
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/file http://www.mulesoft.org/schema/mule/file/current/mule-file.xsd">
	<sub-flow name="get-products" doc:id="27ea8282-78d2-425f-9aa8-6838f75e4db8" >
		<logger level="INFO" doc:name="Request Log" doc:id="1717a521-83f4-44b5-9c68-4674d3282b40" message='#[%dw 2.0&#10;output application/json&#10;---&#10;REQUEST: filePath: "${app.home}/products.csv"]' />
		<file:read doc:name="products.csv" doc:id="6317eecd-8642-4d46-9e9f-6a37dad28cce" path="${app.home}/products.csv" outputMimeType='application/csv; ignoreemptyline=true; separator=";"; header=true' />
		<logger level="INFO" doc:name="Response Log" doc:id="7bfffc65-c557-43a5-9fcf-477af054f910" message='#[%dw 2.0&#10;output application/json&#10;---&#10;RESPONSE: message update {&#10;	case .payload -&gt;&#10;      if ( payload is Object ) if ( sizeOf(payload as String) &gt;= 200 ) (payload as String)[0 to 199] ++ "..."&#10;    else&#10;      payload&#10;      else if ( payload is Array ) if ( sizeOf(payload ) &gt;= 10 ) (payload[0 to 9]) ++ ["..."] else payload&#10;      else&#10;        payload&#10;}]' />
	</sub-flow>
	<sub-flow name="get-and-validate-bad-ingredients" doc:id="7af8eaf5-e65b-4d02-8558-6c526997b7da" >
		<logger level="INFO" doc:name="Request Log" doc:id="77bf177d-d533-4919-bcac-9a58c6deb781" message='#[%dw 2.0&#10;output application/json&#10;---&#10;REQUEST: filePath: "${app.home}/ingredients.csv"]' />
		<file:read doc:name="ingredients.csv" doc:id="f8d5740e-c1c9-4d06-8d65-c050cca3c3f2" path="${app.home}/ingredients.csv" outputMimeType='application/csv; ignoreemptyline=true; separator=","; header=true' target="badIngredientsList" targetValue="#[message]"/>
		<logger level="INFO" doc:name="Response Log" doc:id="8bfcddde-4081-42a1-83c3-7ed36be7e97d" message='#[%dw 2.0&#10;output application/json&#10;var varPayload = vars.badIngredientsList.payload&#10;---&#10;RESPONSE: vars.badIngredientsList update {&#10;	case .payload -&gt;&#10;      if ( varPayload is Object ) if ( sizeOf(varPayload as String) &gt;= 200 ) (varPayload as String)[0 to 199] ++ "..."&#10;    else&#10;      varPayload&#10;      else if ( varPayload is Array ) if ( sizeOf(varPayload ) &gt;= 10 ) (varPayload[0 to 9]) ++ ["..."] else varPayload&#10;      else&#10;        varPayload&#10;}]' />
		<set-variable value='#[%dw 2.0&#10;import * from dw::core::Arrays&#10;var esterPatterns = [/.*stearate$/, /.*palmitate$/, /.*laurate$/, /.*oleate$/, /.*myristate$/, /.*linoleate$/, /.*ricinoleate$/, /.*arachidate$/, /.*behenate$/, /.* ester$/, /mono.*ester/, /di.*ester/, /tri.*ester/, /polysorbate.*/, /tween.*/]&#10;var highSensitivityKeywords = ["ferment", "ferment filtrate", "ferment extract", "yeast", "faex", "saccharomyces"]&#10;output application/json&#10;---&#10;vars.ingredientsList map (item) -&gt; {&#10;	name: item,&#10;	category:&#10;	if ( vars.badIngredientsList.payload some (lower(item) == lower($.ingredients)))&#10;		(vars.badIngredientsList.payload&#10;        	filter (lower(item) == lower($.ingredients))&#10;        )[0].category&#10;    else if ( esterPatterns some (lower(item) matches $) ) "esters"&#10;    else if ( highSensitivityKeywords some (lower(item) contains lower($)) ) "high sensitivity"&#10;    else null&#10;}]' doc:name="validateIngredients" doc:id="bbc9d8ab-b9da-41ef-b1b1-0454dca37ac5" variableName="validateIngredients"/>
		<logger level="INFO" doc:name="Flow Log" doc:id="0e726d8c-0382-46ea-8fb6-9edff99f5fe2" message='#[%dw 2.0&#10;output application/json&#10;---&#10;FLOW: if ( sizeOf(vars.validateIngredients ) &gt;= 10 ) (vars.validateIngredients[0 to 9]) ++ ["..."] else vars.validateIngredients]' />
	</sub-flow>
</mule>
